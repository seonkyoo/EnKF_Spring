<html>
<head>
	<script src="VectorNew.js"></script>
	<script>

	var context,canvas;
	var bodies  = [];
	var springs = [];
	var gravity = 0;
	var deltaT  = 0.1;
	var timer   = null;
	var alpha = 0.01;
  var R1 = (1+alpha*deltaT/2); R2 = (1-alpha*deltaT/2);
	var counter = 0;

	window.onload=getCanvas;    
	function getCanvas(){
		canvas = document.getElementById("myCanvas");
		context=canvas.getContext("2d");
		DrawBox(0,0,canvas.width,canvas.height);
		generateBodies(2);
		generateSprings();
	}

	function generateBodies(n){
		var radius=5;
		bodies.push(Particle(Vector(400,300),radius,Vector(0,0),
			Vector(0,0),1));
		bodies.push(Particle(Vector(500,300),radius,Vector(0,0),
			Vector(0,0),0));
		/*for(var i=0;i<n;i++){
			var x = Math.random()*(canvas.width-radius);
			var y = Math.random()*(canvas.height-radius);
			var pos = Vector(x,y);
			var vel = Vector(2,0);
			// a particle now has a force on it as well
			var force = Vector(0,0);
			var fixedFlag = 0;
			if (i === 0)fixedFlag = 1;
			bodies.push(Particle(pos,radius,vel,force,fixedFlag));
		}
		*/
	}
	function generateSprings(){
		for(var i = 1;i<bodies.length;i++){
			springs.push(Spring(bodies[i-1],bodies[i]));
		}
	}
	function updateParticles(){
		counter++;
		//context.clearRect(0, 0, canvas.width,canvas.height);
		DrawBox(0,0,canvas.width,canvas.height);
		bodies.forEach(zeroForce);
		springs.forEach(updateSpringForces);
		bodies.forEach(updatePosition);
		bodies.forEach(drawBody);
		springs.forEach(drawSpring);
	}

	function Particle(pos,radius,velocity,force,fixedFlag){
		return {pos:pos,radius:radius,velocity:velocity,
			force:force,fixedFlag:fixedFlag};
	}
	// A spring is updated by the motion of its particles
  // 2 particles passed in as parameters
	function Spring(p0,p1){
  	var masses = [p0,p1];
  	var stiffness = 1;
   	var originalLength = p1.pos.minus(p0.pos).abs();
   	originalLength = 60;
  	return {masses:masses, stiffness:stiffness,
  		originalLength:originalLength};
  }
  var updateSpringForces = function(spring){
    var c0 = spring.masses[0].pos;
    var c1 = spring.masses[1].pos;
    var len1 = c1.minus(c0).abs();
    var forcemag = (len1 - spring.originalLength)*spring.stiffness;

    if(forcemag > 10)setDeleteSpring = spring;
    var unitVec = c1.minus(c0).unit(); // unit vector along spring 

    var f = unitVec.scale(forcemag);
    spring.masses[0].force = spring.masses[0].force.plus(f);
    spring.masses[1].force = spring.masses[1].force.minus(f);
  };
  var zeroForce = function(body){
  	body.force = Vector(0,0);
  };
	var updatePosition = function(body){
			var mass = 1;
			if(body.fixedFlag === 0){
				body.velocity.x = 
					R2/R1*body.velocity.x + (deltaT/(2*R1))*body.force.x/(mass);
				body.velocity.y = 
					R2/R1*body.velocity.y + (deltaT/(2*R1))*(body.force.y/(mass)+gravity);

				body.pos.x += body.velocity.x*deltaT; // pos update
				body.pos.y += body.velocity.y*deltaT;
			}
			checkWallCollision(body);
	};
	var checkWallCollision = function(body){
		if (body.pos.x + body.radius >= canvas.width ){
			body.velocity = Vector(-body.velocity.x,body.velocity.y);
		}
		if ((body.pos.x - body.radius) < 0){
			body.velocity = Vector(-body.velocity.x,body.velocity.y);
		}
		if (body.pos.y + body.radius >= canvas.height ){
			body.pos.y = canvas.height-body.radius;
			body.velocity = Vector(body.velocity.x,-body.velocity.y);
		}
		if (body.pos.y - body.radius < 0){
			body.velocity = Vector(body.velocity.x,-body.velocity.y);
		}
	};
	function drawBody(body){
		DrawCircle(body.pos.x,body.pos.y,body.radius);
	}
	function drawSpring(spring){
		DrawLine(spring.masses[0].pos,spring.masses[1].pos);
	}
	function DrawCircle(x,y,radius){
		context.fillStyle = 'rgba(255, 0, 0, .5)';
		context.beginPath();
		context.arc(x, y, radius, 0, Math.PI*2, true);
		context.closePath();
		context.fill();
	}
	function DrawBox(x,y,width,height){
		context.beginPath();
		context.rect(x,y,width,height);
		context.stroke();
		context.closePath();
	}
	function DrawLine(pos0,pos1){
  context.strokeStyle = '#f00'; // red
  context.fillStyle   = '#00f'; // blue
  context.lineWidth   = 2;
  context.beginPath();
  context.moveTo(pos0.x,pos0.y);
  context.lineTo(pos1.x,pos1.y);
  context.stroke();
  context.closePath();
}
	function RunPhysics(){timer = setInterval(updateParticles,20);
  }
  function ResetTimer(){
    if(timer!== null){
      clearInterval(timer); 
      timer = null;
    }
  }
</script>
</head>
<body>
<div>
    <input type="button" value="Start" onclick= "RunPhysics()" />
    <input type="button" value="Stop"  onclick= "ResetTimer()" />
</div>
<div>
	<canvas id="myCanvas" width="800" height="600" > </canvas>
</div>
</body>
</html>