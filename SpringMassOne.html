<html>
<head>
<script src="VectorNew.js"></script>
<script>

	// var context,canvas;
	var bodies  = [];
	var springs = [];
	var gravity = 0;
	var stiffness = 0.1;
	var deltaT  = 0.1;
	var timer   = null;
	var alpha = 0.0;
	var clearFlag = 1;
	var R1 = (1+alpha*deltaT/2); 
	var R2 = (1-alpha*deltaT/2);
	var counter = 0;
	var radius = 5;

	window.onload=getCanvas;    
	function getCanvas(){
		canvas = document.getElementById("myCanvas");
		context=canvas.getContext("2d");
		DrawBox(0,0,canvas.width,canvas.height);
		generateBodies(2);
		generateSprings();
	}

	function generateBodies(n){
		bodies.push(Particle(Vector(300,300),radius,Vector(0,0),Vector(0,0),1));
		// {pos:pos, radius:radius, velocity:velocity, force:force, fixedFlag:fixedFlag};
		bodies.push(Particle(Vector(400,300),radius,Vector(15,0),Vector(0,0),0));
		
	}
	function generateSprings(){
		for(var i = 1;i<bodies.length;i++){
			springs.push(Spring(bodies[i-1],bodies[i]));
		}
	}
	function updateParticles(){
		counter++;
		if(clearFlag == 1) context.clearRect(0, 0, canvas.width,canvas.height);
		DrawBox(0,0,canvas.width,canvas.height);
		bodies.forEach(zeroForce);
		springs.forEach(updateSpringForces);
		bodies.forEach(updatePosition);
		bodies.forEach(drawBody);
		springs.forEach(drawSpring);
	}

	function Particle(pos,radius,velocity,force,fixedFlag){
		return {pos:pos,radius:radius,velocity:velocity,
			force:force,fixedFlag:fixedFlag};
	}
	// A spring is updated by the motion of its particles
	// 2 particles passed in as parameters
	function Spring(p0,p1){
	  	var masses = [p0,p1]; // masses = bodies
	   	var originalLength = p1.pos.minus(p0.pos).abs();
	   	
	  	return {masses:masses, originalLength:originalLength};
	}
	var updateSpringForces = function(spring){
	    var c0 = spring.masses[0].pos;
	    var c1 = spring.masses[1].pos;
	    var len1 = c1.minus(c0).abs();
	    var stif = stiffness;
	    var forcemag = (len1 - spring.originalLength)*stif;

	    if(forcemag > 10) setDeleteSpring = spring;
	    var unitVec = c1.minus(c0).unit(); // unit vector along spring 

	    var f = unitVec.scale(forcemag);
	    spring.masses[0].force = spring.masses[0].force.plus(f);
	    spring.masses[1].force = spring.masses[1].force.minus(f);
	};
	var zeroForce = function(body){
		body.force = Vector(0,0);
	};
	var updatePosition = function(body){
			var mass = 1;
			if(body.fixedFlag === 0){
				body.velocity.x = 
					R2/R1*body.velocity.x + (deltaT/(2*R1))*body.force.x/(mass);
				body.velocity.y = 
					R2/R1*body.velocity.y + (deltaT/(2*R1))*(body.force.y/(mass)+gravity);

				body.pos.x += body.velocity.x*deltaT; // pos update
				body.pos.y += body.velocity.y*deltaT;
			}
			//checkWallCollision(body);
	};
	var checkWallCollision = function(body){
		if (body.pos.x + body.radius >= canvas.width ){
			body.velocity = Vector(-body.velocity.x,body.velocity.y);
		}
		if ((body.pos.x - body.radius) < 0){
			body.velocity = Vector(-body.velocity.x,body.velocity.y);
		}
		if (body.pos.y + body.radius >= canvas.height ){
			body.pos.y = canvas.height-body.radius;
			body.velocity = Vector(body.velocity.x,-body.velocity.y);
		}
		if (body.pos.y - body.radius < 0){
			body.velocity = Vector(body.velocity.x,-body.velocity.y);
		}
	};
	function drawBody(body){
		DrawCircle(body.pos.x,body.pos.y,body.radius);
	}
	function drawSpring(spring){
		DrawLine(spring.masses[0].pos,spring.masses[1].pos);
	}
	function DrawCircle(x,y,radius){
		context.fillStyle = 'rgba(255, 0, 0, .5)';
		context.beginPath();
		context.arc(x, y, radius, 0, Math.PI*2, true);
		context.closePath();
		context.fill();
	}
	function DrawBox(x,y,width,height){
		context.beginPath();
		context.rect(x,y,width,height);
		context.stroke();
		context.closePath();
	}
	function DrawLine(pos0,pos1){
		context.strokeStyle = 'rgba(0,255,0,0.1)'; // green
		context.lineWidth   = 2;
		context.beginPath();
		context.moveTo(pos0.x,pos0.y);
		context.lineTo(pos1.x,pos1.y);
		context.stroke();
		context.closePath();
	}


	// Start Button
	function RunPhysics(){
		timer = setInterval(updateParticles,20);
	}

	// Stop Button
	function ResetTimer(){
		if(timer!== null){
			clearInterval(timer); 
			timer = null;
		}
	}
	// Clear Button
	function Clear(){
		context.clearRect(0, 0, canvas.width,canvas.height);
		clearFlag *= -1;
	}
</script>
</head>
<body>
<div>
    <input type="button" value="Start" onclick= "RunPhysics()" />
    <input type="button" value="Stop"  onclick= "ResetTimer()" />
    <input type="button" value="Clear"  onclick= "Clear()" />
</div>
<div>
	<canvas id="myCanvas" width="800" height="600" > </canvas>
</div>
</body>
</html>